// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  extensions = [vector]
}

enum Role {
  USER
  PHOTOGRAPHER
  ADMIN
}

model User {
  id              String           @id @default(cuid())
  email           String           @unique
  password        String
  name            String?
  role            Role             @default(USER)
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  photos          Photo[]
  sessions        Session[]
  googleDriveAuth GoogleDriveAuth?
  importJobs      ImportJob[]

  @@map("users")
}

model Session {
  id        String   @id @default(cuid())
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("sessions")
}

model Room {
  id         String      @id @default(cuid())
  name       String      @unique
  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt
  photos     Photo[]
  importJobs ImportJob[]

  @@map("rooms")
}

model Photo {
  id             String   @id @default(cuid())
  photographer   String?  // Legacy field for display name
  uploadedById   String?  // New field for user relation
  roomId         String   // Required room association
  azureUrl       String
  metadata       Json?
  capturedAt     DateTime? // Date when the photo was captured
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  faceEmbeddings FaceEmbedding[]
  uploadedBy     User?    @relation(fields: [uploadedById], references: [id], onDelete: SetNull)
  room           Room     @relation(fields: [roomId], references: [id], onDelete: Cascade)

  @@index([uploadedById])
  @@index([roomId])
  @@map("photos")
}

model FaceEmbedding {
  id        String   @id @default(cuid())
  photoId   String
  embedding Unsupported("vector(512)")
  faceId    Int      // Face ID within the image (0, 1, 2, etc.)
  bbox      Json     // Bounding box coordinates [x1, y1, x2, y2]
  confidence Float   // Detection confidence score
  createdAt DateTime @default(now())
  photo     Photo    @relation(fields: [photoId], references: [id], onDelete: Cascade)

  @@index([photoId])
  @@index([faceId])
  @@map("face_embeddings")
}

model GoogleDriveAuth {
  id           String   @id @default(cuid())
  userId       String   @unique
  accessToken  String   // Encrypted
  refreshToken String   // Encrypted
  expiresAt    DateTime
  scope        String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("google_drive_auth")
}

enum ImportJobStatus {
  PENDING      // Job created, not started
  DISCOVERING  // Listing files from Google Drive
  QUEUED       // Files added to SQS
  PROCESSING   // Worker processing files
  COMPLETED    // All files processed
  FAILED       // Job failed
  CANCELLED    // User cancelled
}

model ImportJob {
  id             String          @id @default(cuid())
  userId         String
  roomId         String
  folderId       String          // Google Drive folder ID
  folderName     String
  status         ImportJobStatus @default(PENDING)
  totalFiles     Int             @default(0)
  processedFiles Int             @default(0)
  successFiles   Int             @default(0)
  failedFiles    Int             @default(0)
  errorMessage   String?
  capturedAt     DateTime?       // Date for all photos
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  user           User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  room           Room            @relation(fields: [roomId], references: [id], onDelete: Cascade)
  files          ImportJobFile[]

  @@index([userId])
  @@index([status])
  @@map("import_jobs")
}

enum FileStatus {
  QUEUED
  DOWNLOADING
  UPLOADING
  PROCESSING_EMBEDDINGS
  COMPLETED
  FAILED
}

model ImportJobFile {
  id           String     @id @default(cuid())
  jobId        String
  fileId       String     // Google Drive file ID
  fileName     String
  mimeType     String
  fileSize     Int
  status       FileStatus @default(QUEUED)
  photoId      String?    // ID after successful upload
  errorMessage String?
  retryCount   Int        @default(0)
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  job          ImportJob  @relation(fields: [jobId], references: [id], onDelete: Cascade)

  @@index([jobId])
  @@index([status])
  @@map("import_job_files")
}
